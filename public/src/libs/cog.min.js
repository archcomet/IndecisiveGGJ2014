/*! Cog.js v1.3.1pre | (c) 2013-2014 Michael Good | MIT license. */
(function(){var a=Object.prototype.hasOwnProperty,b=Array.prototype.slice,c=Object.prototype.toString,d=function(){return this instanceof d?this:new d};d.VERSION="1.3.1pre",d.extend=function(){var a,b,c,e,f,g,h=arguments[0]||{},i=1,j=arguments.length,k=!1;for("boolean"==typeof h&&(k=h,h=arguments[i]||{},i++),"object"==typeof h||d.isFunction(h)||(h={}),i===j&&(h=this,i--);j>i;++i)if(null!=(a=arguments[i]))for(b in a)c=h[b],e=a[b],h!==e&&(k&&e&&(d.isPlainObject(e)||(f=d.isArray(e)))?(f?(f=!1,g=c&&d.isArray(c)?c:[]):g=c&&d.isPlainObject(c)?c:{},h[b]=d.extend(k,g,e)):void 0!==e&&(h[b]=e));return h},d.defaults=function B(a,c,d){return b.call(arguments,1).forEach(function(b){if(b)for(var c in b)void 0===a[c]&&(a[c]=b[c])}),a},d.type=function C(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?"object":typeof a},d.isArray=function D(a){return"[object Array]"===c.call(a)},d.isDate=function E(a){return"[object Date]"===c.call(a)},d.isBoolean=function F(a){return a===!0||a===!1||"[object Boolean]"==c.call(a)},d.isFunction=function G(a){return"function"==typeof a},d.isNumber=function H(a){return"[object Number]"===c.call(a)},d.isObject=function I(a){return a===Object(a)},d.isPlainObject=function J(b){if("object"!==d.type(b)||b.nodeType||d.isWindow(b))return!1;try{if(b.constructor&&!a.call(b.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}return!0},d.isRegExp=function K(a){return"[object RegExp]"===c.call(a)},d.isString=function L(a){return"[object String]"===c.call(a)},d.isWindow=function M(a){return null!=a&&a===a.window};var e=!1,f=/xyz/.test(function(){})?/\b_super\b/:/.*/;function g(a,b,c){for(var e in c)a[e]=d.isFunction(c[e])&&d.isFunction(b[e])&&f.test(c[e])?function(a,c){return function(){var d=this._super;this._super=b[a];var e=c.apply(this,arguments);return this._super=d,e}}(e,c[e]):c[e]}function h(a,b,c){var e="_"+b;a[e]=c,Object.defineProperty(a,b,{get:function(){return this[e]},set:function(a){var c=this[e];this[e]=a,this.dirty=!0,d.isFunction(this.trigger)&&this.trigger(b,a,c)},enumerable:!0,configurable:!0})}function i(a,b,c){var d;for(d in b)b.hasOwnProperty(d)&&(c?h(a,d,b[d]):Object.defineProperty(a,d,{value:b[d],configurable:!0,writable:!0,enumerable:!0}))}d.Construct=function N(){return arguments.length?d.Construct.extend.apply(N,arguments):this},d.Construct.create=function(){var a=b.call(arguments);return a.splice(0,0,this),new(Function.prototype.bind.apply(this,a))},d.Construct.prototype.init=function(){},d.Construct.prototype.destroy=function(){},d.Construct.extend=function(a,b,c){var f,h;d.isString(a)||(c=b,b=a,a=null),c||(c=b,b=null),c=c||{},b=b||{},e=!0,f=new this,h=this.prototype,e=!1,g(f,h,c);function j(){if(!(this instanceof j))throw"Constructor called without new keyword";e||this.init.apply(this,arguments)}return j.prototype=f,j.prototype.constructor=j,g(j,{},h.constructor),g(j,h.constructor,b),Object.defineProperty(j,"fullName",{value:a,writable:!1,configurable:!0,enumerable:!1}),j.dirtyOnChange&&Object.defineProperty(j.prototype,"dirty",{value:!0,writable:!0,configurable:!0,enumerable:!1}),c.defaults&&i(j.prototype,c.defaults,j.dirtyOnChange),c.properties&&Object.defineProperties(j.prototype,c.properties),j.defaults&&i(j,j.defaults,!1),j.properties&&Object.defineProperties(j,j.properties),j.setup&&j.setup(),j};var j={enable:function(){this._enabled=!0},disable:function(){this._enabled=!1},log:function(a){this._enabled&&console.log(a)}};d.extend({debug:j});var k=d.Construct.extend("cog.ArrayWrapper",{init:function(a,b){if(!this.get){var c;c=a instanceof k?a.serialize():d.isArray(a)?a.slice(0):new Array(d.isNumber(a)?a:0),b||(this.add=function(a){return c.push(a),this},this.insert=function(a,b){return c.splice(b,0,a),this},this.remove=function(a){var b=c.indexOf(a);return b>-1&&c.splice(b,1),this},this.removeAtIndex=function(a){return c.splice(a,1),this},this.removeAll=function(){return c.length=0,this},this.removeLast=function(){return c.pop(),this}),this.get=function(a){return c[a]},this.each=function(a){for(var b=0,d=c.length;d>b;++b)a(c[b],b);return this},this.length=function(){return c.length},this.serialize=function(){return c.slice(0)},this.clone=function(){return new k(this,b)},this.readyOnly=function(){return new k(this,!0)}}}}),l=d.Construct.extend("cog.SetWrapper",{init:function(a,c){if(!this.get){var e;e=a instanceof l?a.serialize():d.isObject(a)?d.extend({},a):{},c||(this.set=function(a,b){return e[a]=b,this},this.remove=function(a){for(var b in e)if(e.hasOwnProperty(b)&&e[b]===a)return this.removeKey(b);return this},this.removeKey=function(a){return delete e[a],this},this.removeAll=function(){for(var a in e)e.hasOwnProperty(a)&&delete e[a];return this},this.extend=function(){var a=b.call(arguments);return a.splice(0,0,e),d.extend.apply(d.extend,a),this}),this.get=function(a){return e[a]},this.each=function(a){for(var b in e)e.hasOwnProperty(b)&&a(e[b],b);return this},this.count=function(){var a=0;for(var b in e)e.hasOwnProperty(b)&&++a;return a},this.serialize=function(){return d.extend({},e)},this.clone=function(){return new l(this,c)},this.readOnly=function(){return new l(this,!0)}}}});d.extend({ArrayWrapper:k,SetWrapper:l});var m=function(){var a,b=256,c=6,d=52,e=new Array(b),f=[],g=Math.pow(b,c),h=Math.pow(2,d),i=2*h,j=b-1;function k(a){var b,c=0,d=a+"";for(f.length=0;c<d.length;++c)f[j&c]=j&(b^=19*f[j&c])+d.charCodeAt(c)}function l(){var a,c,d=0,g=f.length;for(c=0;b>c;++c)e[c]=c;for(c=0;b>c;++c)d=(d+e[c]+f[c%g])%b,a=e[c],e[c]=e[d],e[d]=a}var m={i:0,j:0,out:function(a){var c=this.i,d=this.j,f,g=0;while(a--)f=e[c=(c+1)%j],g=g*b+e[j&(e[c]=e[d=j&d+f])+(e[d]=f)];return this.i=c,this.j=d,g}};function n(){var a=m.out(c),d=g,e=0;while(h>a)a=(a+e)*b,d*=b,e=m.out(1);while(a>=i)a/=2,d/=2,e>>>=1;return(a+e)/d}function o(b){return arguments.length>0?(k(b),l(),m.i=0,m.j=0,a=b,b):a}function p(){return o(Math.random())}function q(){return o(Date.now())}function r(){return m.out(1)}function s(a,b){var c=n(),d=arguments.length;return 0===d?c:(1===d&&(b=a,a=0),c*(b-a)+a)}function t(a,b){var c=n(),d=arguments.length;return 0===d?Math.floor(2*c):(1===d&&(b=a,a=0),Math.floor(c*(b-a+1))+a)}return q(),{seed:o,seedRand:p,seedTime:q,arc4rand:s,arc4randInt:t,arc4rand255:r}}();d.extend({rand:m});function n(){for(var a,b=0,c=0,d=arguments.length;d>c;++c)(a=arguments[c])&&a.category&&(b|=a.category);return b}var o=d.Construct.extend("cog.Entity",{components:null,_manager:null,_tag:null,properties:{manager:{get:function(){return this._manager}},id:{get:function(){return this._id}},tag:{get:function(){return this._tag}},valid:{get:function(){return this._manager&&this._id?!0:!1}},parent:{get:function(){return this._parent}},children:{get:function(){return this._children.slice(0)}}},init:function(a,b,c){this._manager=a,this._id=b,this._tag=c||null,this._components={},this._parent=null,this._children=[],this.components=p.make(this)},destroy:function(a){return this._manager&&!a?(this._manager.remove(this),void 0):(this.components.removeAll(),this._manager=void 0,this._id=void 0,this._tag=void 0,this._children=void 0,void 0)},clone:function(){var a,b,c=this.components._components,d=this._manager.add(this._tag);for(a in c)c.hasOwnProperty(a)&&(b=c[a],d.components.assign(b.constructor,b.serialize()));return d},addChild:function(a){return a.parent&&a.parent.removeChild(a),a._parent=this,this._children.push(a),this._manager.director.events.emit("entity addChild",this,a),this},removeChild:function(a){var b;return a.parent===this&&(a._parent=null,b=this._children.indexOf(a),b>-1&&(this._children.splice(b,1),this._manager.director.events.emit("entity removeChild",this,a))),this},removeAllChildren:function(){for(var a=this._children,b=a.length-1;b>=0;--b)this.removeChild(a[b]);return this}}),p={assign:function(a,b){if(!a||!a.category)return null;var c,d=a.category;return(d&this._componentMask)===d?(c=this._components[d],c.set(b)):(c=this._components[d]=new a(this._entity,b),this._componentMask|=d,this._eventManager.emit(a.eventTarget+" assigned",c,this._entity)),c},remove:function(a){a instanceof d.Component&&(a=a.constructor);var b,c=a.category;return(c&this._componentMask)===c&&(b=this._components[c],this._componentMask&=~c,this._components[c]=void 0,this._eventManager.emit(a.eventTarget+" removed",b,this._entity),b.destroy(!0)),this},removeAll:function(){var a;for(a in this._components)this._components.hasOwnProperty(a)&&this.remove(this._components[a]);return this},has:function(a){var b=n.apply(n,arguments);return 0!==b&&(b&this._componentMask)===b},_entity:null,_components:null,_componentMask:0,_eventManager:null,make:function(a){function b(a){var c,d,e=b._components;if(a)return a.category?e[a.category]:null;d=[];for(c in e)e.hasOwnProperty(c)&&d.push(e[c]);return d}return b._componentMask=this._componentMask,b._components=a._components,b._eventManager=a.manager.director.events,b._entity=a,b.has=this.has,b.mask=this.mask,b.assign=this.assign,b.remove=this.remove,b.removeAll=this.removeAll,Object.defineProperties(b,{mask:{get:function(){return this._componentMask}}}),b}};d.extend({Entity:o});function q(a,b,c){if(a>b)throw c}var r=0,s=d.Construct.extend("cog.Component",{eventTarget:"component",properties:{category:{get:function(){return this._category}},count:{get:function(){return r-1}}},setup:function(){q(r,64,"Exceeded 64 Component types."),this._category=0===r?0:1<<r-1,r++}},{properties:{entity:{get:function(){return this._entity}},valid:{get:function(){return void 0!==this._entity}}},init:function(a,b){this._entity=a,this._listeners={},this.set(b)},set:function(a){for(var b in a)a.hasOwnProperty(b)&&this.prop(b,a[b])},prop:function(a,b){if(2===arguments.length){var c=this[a];return this[a]=b,this.trigger(a,b,c),void 0}return this[a]},on:function(a,b){var c=this._listeners[a];c||(c=this._listeners[a]=[]),c.push(b)},off:function(a){if(a)this._listeners[a]&&(this._listeners[a].length=0);else for(a in this._listeners)this._listeners.hasOwnProperty(a)&&(this._listeners[a].length=0)},trigger:function(a,b,c){var d,e,f=this._listeners[a];if(f)for(d=0,e=f.length;e>d;++d)f[d](b,c)},keys:function(){var a,b=[];for(a in this.defaults)this.defaults.hasOwnProperty(a)&&b.push(a);for(a in this.properties)if(this.properties.hasOwnProperty(a)){if("entity"===a||"valid"===a)continue;if(b.indexOf(a)>-1)continue;b.push(a)}return b},serialize:function(){var a,b={};for(a in this.defaults)this.defaults.hasOwnProperty(a)&&(b[a]=this[a]);for(a in this.properties)if(this.properties.hasOwnProperty(a)){if("entity"===a||"valid"===a)continue;b[a]=this[a]}return b},destroy:function(a){return!a&&this._entity&&this._entity.components?(this._entity.components.remove(this),void 0):(this.off(),this._entity=void 0,void 0)}});d.extend({Component:s});var t=0,u=d.Construct.extend("cog.System",{properties:{systemId:{get:function(){return this._systemId}},count:{get:function(){return t-1}}},setup:function(){this._systemId=t-1,t++}},{properties:{manager:{get:function(){return this._manager}}},init:function(a){this._manager=a},destroy:function(a){return this._manager&&!a?(this._manager.remove(this),void 0):(this._manager=void 0,void 0)},configure:function(a,b,c){},update:function(a,b,c){},render:function(a){}});d.extend({System:u});var v=d.System.extend("cog.Factory",{entityTag:null,components:{},init:function(a){if(this._entityManager=a.director.entities,this._super(a),this._entities=[],d.isString(this.entityTag)){var b=this;this["spawn "+this.entityTag+" event"]=function(){b.spawn.apply(b,arguments)}}},spawn:function(a){var b,c=this._entityManager.add(this.entityTag),e=this.components,f,g;for(b in e)e.hasOwnProperty(b)&&(f=e[b],g=a&&a[b]?a[b]:{},d.defaults(g,f.defaults),c.components.assign(f.constructor,g));return this._entities.push(c),c},despawn:function(a){var b=this._entities.indexOf(a);b>-1&&(this._entities.splice(b,1),a.destroy())}});d.extend({Factory:v});var w=d.Construct.extend("cog.EntityManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._director=a,this._entities=[],this._entityId=1},destroy:function(){this.removeAll(),this._director=void 0},add:function(a){var b=new o(this,this._entityId++,a);return this._entities.push(b),this._director.events.emit("entity added",b),b},all:function(){for(var a=0,b=this._entities.length,c=[];b>a;++a)c.push(this._entities[a]);return c},withTag:function(a){var b,c=0,d=this._entities.length,e=[];if(a)for(;d>c;++c)b=this._entities[c],b.tag===a&&e.push(b);return e},withComponents:function(){for(var a,b=n.apply(n,arguments),c=0,d=this._entities.length,e=[];d>c;++c)a=this._entities[c],(b&a.components._componentMask)===b&&e.push(a);return e},remove:function(a){var b=this._entities.indexOf(a);return b>-1&&(this._entities.splice(b,1),this._director.events.emit("entity removed",a),a.destroy(!0)),this},removeAll:function(){for(var a,b=this._entities.length-1;b>-1;--b)a=this._entities.splice(b,1)[0],this._director.events.emit("entity removed",a),a.destroy(!0);return this},removeWithTag:function(a){for(var b,c=this._entities.length-1;c>-1;--c)this._entities[c].tag===a&&(b=this._entities.splice(c,1)[0],this._director.events.emit("entity removed",b),b.destroy(!0));return this},removeWithComponents:function(){for(var a,b=this._entities.length-1,c=n.apply(n,arguments);b>-1;--b)a=this._entities[b],(c&a.components._componentMask)===c&&(a=this._entities.splice(b,1)[0],this._director.events.emit("entity removed",a),a.destroy(!0));return this}});d.extend({EntityManager:w});var x=/.* event$/,y=d.Construct.extend("cog.SystemManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._director=a,this._eventContexts={},this._eventCallbacks={}},destroy:function(){this.unregisterAll(),this._director=void 0},emit:function(a){var c,d,e,f=this._eventContexts[a],g=this._eventCallbacks[a];if(f&&g)for(e=b.call(arguments,1),c=0,d=g.length;d>c;++c)g[c].apply(f[c],e);return this},register:function(a,b,c){if(!d.isObject(b)||!d.isFunction(c))return this;var e=this._eventContexts[a],f=this._eventCallbacks[a];return(void 0===e||void 0===f)&&(e=this._eventContexts[a]=[],f=this._eventCallbacks[a]=[]),e.push(b),f.push(c),this},registerContext:function(a){var b,c;for(b in a)(c=a[b])&&d.isFunction(c)&&x.test(b)&&this.register(b.substring(0,b.length-6),a,c);return this},unregister:function(a,b){var c,d=this._eventContexts[a],e=this._eventCallbacks[a];if(d&&e)for(c=d.length-1;c>=0;--c)d[c]===b&&(d.splice(c,1),e.splice(c,1));return this},unregisterContext:function(a){for(var b in this._eventContexts)this._eventContexts.hasOwnProperty(b)&&this.unregister(b,a);return this},unregisterEvent:function(a){var b=this._eventContexts[a],c=this._eventCallbacks[a];return b&&c&&(this._eventContexts[a].length=0,this._eventCallbacks[a].length=0),this},unregisterAll:function(){for(var a in this._eventContexts)this._eventContexts.hasOwnProperty(a)&&this.unregisterEvent(a);return this}});d.extend({EventManager:y});var z=d.Construct.extend("cog.SystemManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._systems={},this._systemOrder=[],this._director=a},destroy:function(){this.removeAll(),this._director=void 0},add:function(a){if(!a||!a.systemId)return void 0;var b=a.systemId,c=this._systems[b];return c||(c=new a(this),this._systems[b]=c,this._systemOrder.push(c),this._director.events.registerContext(c),c.configure(this._director.entities,this._director.events,this._director.config)),c},get:function(a){var b=a.systemId;return this._systems[b]},remove:function(a){var b,c,e;return a instanceof d.System&&(e=a,a=e.constructor),a&&a.systemId?(c=a.systemId,e||(e=this._systems[c]),e&&(b=this._systemOrder.indexOf(e),this._director.events.unregisterContext(e),this._systemOrder.splice(b,1),this._systems[c]=void 0,e.destroy(!0)),this):this},removeAll:function(){var a,b,c;for(b in this._systems)this._systems.hasOwnProperty(b)&&(c=this._systems[b],c&&(a=this._systemOrder.indexOf(c),this._director.events.unregisterContext(c),this._systemOrder.splice(a,1),this._systems[b]=void 0,c.destroy(!0)));return this},update:function(a){for(var b=0,c=this._systemOrder.length,d=this._systemOrder,e=this._director.entities,f=this._director.events;c>b;++b)d[b].update(e,f,a);return this},render:function(){for(var a=0,b=this._systemOrder.length,c=this._systemOrder,d=this._director.entities;b>a;++a)c[a].render(d);return this}});d.extend({SystemManager:z}),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)}),window.performance||(window.performance={now:function(){return Date.now()}})}();var A=d.Construct.extend("cog.Director",{create:function(a){return new A(a)}},{_entityManager:null,_eventManager:null,_systemManager:null,_animationFrame:null,defaults:{_targetDt:1e3/60,_accumulator:0,_lastFrame:0},properties:{config:{get:function(){return this._config}},events:{get:function(){return this._eventManager}},entities:{get:function(){return this._entityManager}},systems:{get:function(){return this._systemManager}},valid:{get:function(){return void 0!==this._entityManager&&void 0!==this._systemManager&&void 0!==this._eventManager}}},init:function(a){this._config=a,this._eventManager=new y(this),this._entityManager=new w(this),this._systemManager=new z(this),this._beginUpdateCallback=null,this._animationFrame=null,this._fixedDt=a&&d.isBoolean(a.fixedDt)?a.fixedDt:!1},destroy:function(){this.stop(),this._entityManager.destroy(),this._eventManager.destroy(),this._systemManager.destroy(),this._entityManager=void 0,this._systemManager=void 0,this._eventManager=void 0,this._beginUpdateCallback=void 0,this._endUpdateCallback=void 0},start:function(){this._animationFrame||(this._lastFrame=0,this._animationFrame=requestAnimationFrame(this.step.bind(this)))},stop:function(){this._animationFrame&&(cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},step:function(a){var b=this._targetDt,c=this._lastFrame,d=this._accumulator,e=0===c?b:a-c;if(this._beginStepCallback&&this._beginStepCallback(),this._fixedDt){d+=e;while(d>b)this.update(b),d-=b;this._accumulator=d}else this.update(e);this.render(),this._endStepCallback&&this._endStepCallback(),this._animationFrame&&(this._lastFrame=a,this._animationFrame=requestAnimationFrame(this.step.bind(this)))},update:function(a){this._beginUpdateCallback&&this._beginUpdateCallback(),this._systemManager.update(a),this._endUpdateCallback&&this._endUpdateCallback()},render:function(){this._systemManager.render()},onBeginUpdate:function(a){return this._beginUpdateCallback=a,this},onEndUpdate:function(a){return this._endUpdateCallback=a,this},onBeginStep:function(a){return this._beginStepCallback=a,this},onEndStep:function(a){return this._endStepCallback=a,this}});d.extend({Director:A,createDirector:A.create}),"function"==typeof define&&define.amd&&define("cog",[],function(){return d}),this.cog=d}).call(this);
//# sourceMappingURL=cog.min.map